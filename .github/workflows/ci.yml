name: CI

on:
  push:
    branches: [main]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Create .env file
      run: |
        echo "${{ secrets.DOT_ENV_FILE }}" > .env

    - name: Build Docker image
      run: docker build -t 3o3 .

    - name: Run tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/allure-results:/app/allure-results \
          3o3 
    
    - name: Get Allure history
      uses: actions/checkout@v3
      if: always()
      continue-on-error: true
      with:
        ref: gh-pages
        path: gh-pages  

    - name: Restore Allure history
      run: |
        if [ -d gh-pages/allure-history ]; then
          cp -r gh-pages/allure-history allure-history
        fi

    - name: Allure Report action
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        allure_results: allure-results
        allure_history: allure-history
        keep_reports: 20

    - name: Deploy report to Github Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: allure-history

    - name: Slack Notify - Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{
          \"text\": \":white_check_mark: *CI 테스트 성공!*\\n
          *Repo:* ${{ github.repository }}\\n
          *Branch:* ${{ github.ref_name }}\\n
          *Commit:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\\n
          *Allure Report:* https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\"
        }" \
        ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Slack Notify - Failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{
          \"text\": \":x: *CI 테스트 실패!*\\n
          *Repo:* ${{ github.repository }}\\n
          *Branch:* ${{ github.ref_name }}\\n
          *Commit:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\\n
          *Check Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\"
        }" \
        ${{ secrets.SLACK_WEBHOOK_URL }}
